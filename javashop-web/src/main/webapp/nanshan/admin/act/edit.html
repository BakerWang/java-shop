<#include '/admin/sonheader.html' >
<#assign dateformat= "com.enation.framework.directive.DateformateDirective"?new()>
<style>
.layui-form-pane .layui-input:focus, .layui-form-pane .layui-textarea:focus
	{
	border-radius: 2px;
	border-color: #01AAED !important;
}
   form{margin-bottom:0px;}
</style>
<script type="text/javascript" src="${ctx}/nanshan/js/context.js"></script>
<div class="main">
	<!--表单区域  -->
	<div class="main-top">
	   
		<form id="addmodelForm" class="layui-form layui-form-pane" action=""
			enctype="multipart/form-data" style="padding-top: 10px">
			 <#include '${ctx}/nanshan/common/spec.html' >
			<div class="layui-form-item">
				<label class="layui-form-label">分类:</label>
				<div class="layui-input-block">
	      			<select>
	                    <option value="38" <#if data.cat_id==38> selected="selected" </#if>>最新活动</option>
	                    <option value="39" <#if data.cat_id==39> selected="selected" </#if>>活动回顾</option>
	      			</select>
    		     </div>
			</div>

			<div class="layui-form-item">
				<label class="layui-form-label">文章标题:</label>
	    		<div class="layui-input-block">
	    		    <input name="id" type='hidden'  value="${data.id}" maxlength="60" dataType="string" lay-verify="required" autocomplete="off" class="layui-input">
	    		     <input name="content_id" type='hidden'  value="${data.content_id}" maxlength="60" dataType="string" lay-verify="required" autocomplete="off" class="layui-input">
	      			<input type="text" name="title" id="uri" value="${data.title!''}" maxlength="60" dataType="string" lay-verify="required" autocomplete="off" class="layui-input">
	    		</div>
			</div>
			  		<div class="layui-form-item">
    		<label class="layui-form-label">文章摘要：</label>
    		<div class="layui-input-block">
    		    <textarea name="summary" id="summary" style="height:100px" placeholder="请输入内容" class="layui-textarea">${data.summary!''}</textarea>
    		</div>
  		</div>
				<div class="layui-form-item">
    		<label class="layui-form-label">注意事项：</label>
    		<div class="layui-input-block">
    		    <textarea name="notice" id="notice" style="height:100px" placeholder="请输入内容" class="layui-textarea"></textarea>
    		</div>
  		</div>

			<div class="layui-form-item">
	    		<label class="layui-form-label">创建时间:</label>
	    		<div class="layui-input-inline" >
	      			<input class="layui-input" placeholder="创建时间" name="createTime" lay-verify="required" onclick="layui.laydate({elem: this, istime: true, format: 'YYYY-MM-DD hh:mm:ss'})" style="width:100%;height:38px;" value='<@dateformat time='${data.create_time}' pattern='yyyy-MM-dd hh:mm:ss'/>' />
	    		</div>
  		    </div>
			<div class="layui-form-item">
	    		<label class="layui-form-label">列表图片：</label>
	    		<input type="hidden" name="pic_url" id="picUrl">
				<div class="layui-input-inline" style="width:120px;">
					<input name="file" class="layui-upload-file" id="exhImgUploadBtn" type="file">	
				</div>
				<div id="exhImg" class="layui-inline">
				<#if data.pic_url??>
						<img src="${data.pic_url}" width='130' height='130' />
						<a class="layui-btn layui-btn-sm layui-btn-danger" onclick="return delImg();"><i class='layui-icon'>&#xe640;</i></a>
					</#if>
				</div>
	  		</div>
	  		
	  		 <div class="layui-form-item">
	    		<label class="layui-form-label">文章大图：</label>
	    		<input type="hidden" name="big_pic_url" id="big_pic_url">
				<div class="layui-input-inline" style="width:120px;">
					<input name="file" class="layui-upload-file" id="bigImgUploadBtn" type="file">	
				</div>
				<div id="bigImg" class="layui-inline"></div>
  		    </div>
  		   	<div id="act">
  		   
		  		<div class="layui-form-item">
		    		<label class="layui-form-label">活动对象：</label>
		    		<div class="layui-input-block">
		    		<input type="text" name="act_name"  value="${(data.act_name)!''}" maxlength="60" dataType="string" lay-verify="required" autocomplete="off" class="layui-input">
		    		</div>
		  		</div>
		  		<div class="layui-form-item">
		    		<label class="layui-form-label">截止时间：</label>
		    		<div class="layui-input-inline">
		    		<input class="layui-input" placeholder="截止时间" name="expiryDate" lay-verify="required" onclick="layui.laydate({elem: this, istime: true, format: 'YYYY-MM-DD hh:mm:ss'})" style="width:100%;height:38px;" value='<@dateformat time='${data.expiryDate}' pattern='yyyy-MM-dd hh:mm:ss'/>' />
		    		</div>
	  		    </div>
		  		<div class="layui-form-item">
		    		<label class="layui-form-label">活动费用：</label>
		    		<div class="layui-input-block">
		    		<input type="text" name="act_cost"  value="${(data.act_cost)!''}" maxlength="60" dataType="string" lay-verify="required" autocomplete="off" class="layui-input">
		    		</div>
		  		</div>
		  		<div class="layui-form-item">
		    		<label class="layui-form-label">活动地址：</label>
		    		<div class="layui-input-block">
		    		   <input type="text" name="act_address" value="${(data.act_address)!''}"  maxlength="60" dataType="string" lay-verify="required" autocomplete="off" class="layui-input">
		    		</div>
		  		</div>
		  		<div class="layui-form-item">
		    		<label class="layui-form-label" style="width:120px">可预约人数：</label>
		    		<div class="layui-input-inline">
		    		   <input type="text" name="reserve_num" lay-verify="number" value="${(data.reserve_num)!''}" maxlength="60" dataType="string" lay-verify="required" autocomplete="off" class="layui-input">
		    		</div>
		  		</div>
		  		<div class="layui-form-item">
		    		<label class="layui-form-label"  style="width:120px">已预约人数：</label>
		    		<div class="layui-input-inline">
		    		   <input type="text" name="reserve_num" readOnly="true" value="${(data.reserved_num)!''}" maxlength="60" dataType="string" lay-verify="required" autocomplete="off" class="layui-input">
		    		</div>
		  		</div>
	  		</div>
  		   
           <div class="layui-form-item">
	    		<label class="layui-form-label">活动详情：</label>
	    		<fieldset class="layui-elem-field site-demo-button" style="margin-top: 30px;">
					<legend>编辑区</legend>
					<div id="article"></div>
					<div class="layui-form-item">
		    			<a class="layui-btn" onclick="add();">增加段落</a>
		    			<div class="layui-input-inline" style="width:120px;">
							<input name="file" class="layui-upload-file" id="exhInfoImgUploadBtn" type="file">	
						</div>
		  			</div>
					
				</fieldset>
	  		</div>
			<div class="layui-form-item">
				<div class="layui-layer-btn layui-layer-btn-"
					style="padding: 8px 12px; z-index: 1000;">
					<a class="layui-layer-btn0" type="submit" lay-submit=""	lay-filter="editModel">保存</a>
				</div>
			</div>
		</form>
	</div>	
</div>

<!--js区域  -->
<script>
var table;
var desc='${(data.content)!''}';
var specIds='${data.specValIds!''}'
if(desc!=''&&desc.match("^\{(.+:.+,*){1,}\}$")){
	var obj=eval('(' + desc + ')');
	var context=obj.content;
	var bigImg=obj.big_pic_url;
	var notice=obj.notice;
	if(notice!=""&&notice!=undefined){
		var reg = new RegExp("<br/>","g");//g,表示全部替换。
		notice=notice.replace(reg,'\n'); 
		$("#notice").html(notice)
	}
	if(bigImg!=""&&bigImg!=undefined){
	$("#big_pic_url").val(bigImg);
	$("#bigImg").html(getPicHtml(bigImg));
	}
	initContextHtml(context);	
}
initSpecId(specIds); 
var index = parent.layer.getFrameIndex(window.name);
layui.use(['form', 'layedit', 'laydate','upload'], function(){
    var form = layui.form()
        ,layer = layui.layer
        ,layedit = layui.layedit
        ,laydate = layui.laydate;
    layui.upload({
	    url: '/core/admin/nanshan/upload.do'
	    ,elem: '#exhImgUploadBtn' 
	    ,method: 'POST'
	    ,success: function(res){
	    	$("#exhImg").html(getPicHtml(res.url));
	    	$("#picUrl").val(res.url);
	    }
	});
	layui.upload({
	    url: '/core/admin/nanshan/upload.do'
	    ,elem: '#bigImgUploadBtn' 
	    ,method: 'POST'
	    ,success: function(res){
	    	$("#bigImg").html(getPicHtml(res.url));
	    	$("#big_pic_url").val(res.url);
	    }
	});
	
	
	layui.upload({
	    url: '/core/admin/nanshan/upload.do'
		    ,elem: '#exhInfoImgUploadBtn' 
		    ,method: 'POST'
		    ,success: function(res){
		    	$("#article").append("<div class='layui-form-item'>"+
		    		    "<div class='layui-inline'>"+
		    				"<img name='img' src='"+res.url+"'  width='112' height='112' />"+	
		    	    	"</div>"+
		    	    	"<div class='layui-inline'>"+
		    	      		"<a class='layui-btn layui-btn-sm layui-btn-danger' onclick='delButton(this);' style='margin-left:10px'><i class='layui-icon'>&#xe640;</i></a>"+
		    	    	"</div>"+
		    	  	"</div>");
		    }
		});
    

form.on('submit(editModel)', function(data){
	var actExt=getActExt();
	var specValue=getSpecValId();
	var content=getContext();
	var con=new Object();
	    con.content=content;
	    con.big_pic_url=$("#big_pic_url").val();
	    var notice=$("#notice").val();
	    if(notice!=""){
	    	var reg = new RegExp(/\n|\r\n/g,"g");//g,表示全部替换。
	    	notice=notice.replace(reg,"<br/>");
	    	con.notice=notice;
	    }
	    con.actExt=actExt
	var content=JSON.stringify(con);
	var options = {
		url : ctx+"/admin/article/save-edit.do",
		type : "POST",
		dataType : 'json',
		data:{"content":content,"specValIds":specValue},
		success : function(result) {
			if (result.result == 1) {
				$.Loading.success(result.message);
				
			}
			if (result.result == 0) {
				$.Loading.error(result.message);
			}
		},
		error : function(e) {
			$.Loading.error("出现错误 ，请重试");
		}
	};
	$("#addmodelForm").ajaxSubmit(options);
	
	return false;
});

});

//修改字段弹框
	 function edit(fieldid){
		 var modelid=$("#modelid").val();
	　　	 layer.open({
	            title:"修改字段",//标题
	            maxmin :true,//右上角可否放大缩小
	            type:2,//弹框的类型
	            shade: [0.3, '#000'],//黑色背景
	            offset: '10px',//弹框位置
	            shadeClose:false,//黑色背景是否可以点击关闭
	            content:'${ctx}/cms/admin/field/edit.do?modelid='+modelid+'&fieldid='+fieldid+'&ajax=yes',//内容的URL
	            area:['700px','450px'],//弹框大小
	            scrollbar: true//是否允许浏览器出现滚动条
	        });
	 }
	 
	 function getPicHtml(url){
		 var html="<img src='"+url+"' width='130' height='130' />"+
			"<a class='layui-btn layui-btn-sm layui-btn-danger' onclick='delImg();' style='margin-left:10px'><i class='layui-icon'>&#xe640;</i></a>"
			return html;
	 }
	


  
</script>
<#include '/admin/footer.html' >
